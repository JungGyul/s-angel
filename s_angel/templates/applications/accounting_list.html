<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>회계 장부</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  {% load humanize %}

<style>
  :root{
    --navy:#1E3A8A;
    --bg:#F9FAFB;
    --card:#FFFFFF;
    --border:#E5E7EB;
    --text:#334155;
    --muted:#64748B;
    --green:#10B981;
    --red:#EF4444;

    --shadow: 0 10px 18px rgba(15, 23, 42, 0.06);
  }

  .acc-page{
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    padding: 1.75rem 0;
  }
  .acc-wrap{
    max-width: 960px;
    margin: 0 auto;
    padding: 0 1rem;
  }

  .acc-header{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap: 1rem;
    margin-bottom: 1.1rem;
  }

  .acc-title{
    margin:0;
    font-size: 1.45rem;
    font-weight: 900;
    border-left: 4px solid var(--navy);
    padding-left: .85rem;
    line-height: 1.15;
  }
  .acc-subtitle{
    margin-top: .35rem;
    color: var(--muted);
    font-size: .95rem;
    padding-left: .95rem;
    line-height: 1.4;
  }

  .btn-ghost{
    background: var(--card);
    border: 1px solid var(--border);
    color: var(--text);
    font-weight: 800;
    padding: .55rem .9rem;
    border-radius: .65rem;
    text-decoration:none;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:.45rem;
    transition: .15s ease;
    white-space: nowrap;
  }
  .btn-ghost:hover{ background:#F1F5F9; }

  .top-row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: .8rem;
    margin: .75rem 0 1.1rem;
    flex-wrap: wrap;
  }

  .year-select{
    display:flex;
    align-items:center;
    gap:.6rem;
    flex-wrap: wrap;
  }
  .select{
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: .75rem;
    padding: .55rem .75rem;
    font-weight: 900;
    color: var(--text);
    outline: none;
    box-shadow: var(--shadow);
  }
  .year-chip{
    display:inline-flex;
    align-items:center;
    gap:.45rem;
    padding:.5rem .75rem;
    border: 1px solid var(--border);
    border-radius: 999px;
    background: #fff;
    font-weight: 900;
    color: var(--muted);
    text-decoration:none;
  }
  .year-chip.active{
    border-color: rgba(30,58,138,.35);
    background: rgba(30,58,138,.07);
    color: var(--navy);
  }

  .acc-actions{
    display:flex;
    justify-content:flex-end;
    gap: .6rem;
    flex-wrap: wrap;
  }

  .btn-action{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:.5rem;
    padding: .65rem 1rem;
    border-radius: .7rem;
    font-weight: 900;
    text-decoration:none;
    border: 1px solid transparent;
    transition: .15s ease;
    white-space: nowrap;
  }

  .btn-excel{
    background: transparent;
    border-color: #22C55E;
    color: #166534;
  }
  .btn-excel:hover{ background: rgba(34,197,94,.08); }

  .btn-add{
    background: var(--navy);
    color: #fff;
    border: none;
    box-shadow: 0 10px 18px rgba(30,58,138,.18);
  }
  .btn-add:hover{ filter: brightness(.97); }

  .btn-event{
    background: transparent;
    border-color: rgba(30,58,138,.28);
    color: var(--navy);
  }
  .btn-event:hover{ background: rgba(30,58,138,.06); }

  .sum-grid{
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap: .85rem;
    margin-bottom: 1.25rem;
  }
  .sum-card{
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 1rem;
    padding: 1.1rem 1.05rem;
    box-shadow: var(--shadow);
  }
  .sum-label{
    font-size: .88rem;
    color: var(--muted);
    margin-bottom: .35rem;
    font-weight: 800;
  }
  .sum-value{
    font-size: 1.35rem;
    font-weight: 1000;
    letter-spacing: -0.02em;
  }
  .sum-balance{ color: var(--navy); }
  .sum-income{ color: var(--green); }
  .sum-expense{ color: var(--red); }

  .table-card{
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 1rem;
    box-shadow: var(--shadow);
    overflow: hidden;
  }

  .acc-table{
    width: 100%;
    border-collapse: collapse;
  }

  .acc-table thead th{
    background: #F8FAFC;
    color: var(--muted);
    font-size: .85rem;
    font-weight: 900;
    padding: .95rem .9rem;
    border-bottom: 1px solid var(--border);
    vertical-align: middle;
    white-space: nowrap;
    text-align: center;
  }

  .acc-table td{
    padding: .9rem .9rem;
    border-bottom: 1px solid #F1F5F9;
    vertical-align: middle;
    text-align: center;
  }

  .acc-table td[data-label="금액"]{
    text-align: right;
  }

  .acc-table tbody tr:hover{
    background: #FBFDFF;
  }

  .badge-cat{
    display:inline-flex;
    align-items:center;
    padding: .28rem .55rem;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: #F8FAFC;
    color: #334155;
    font-weight: 800;
    font-size: .82rem;
    justify-self: start;
    max-width: 100%;
    width: auto;
  }

  .badge-event{
    border-color: rgba(30,58,138,.25);
    background: rgba(30,58,138,.07);
    color: var(--navy);
  }

  .money{
    font-weight: 1000;
    white-space: nowrap;
  }
  .money.income{ color: var(--green); }
  .money.expense{ color: var(--red); }
  .money.total{ color: var(--navy); }

  .link-row{
    text-decoration:none;
    color: inherit;
    font-weight: 1000;
  }

  .manage-wrap{
    display:flex;
    justify-content:center;
    gap:.5rem;
    flex-wrap:nowrap;
  }

  .action-pill{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:.45rem;
    padding:.48rem .8rem;
    border-radius:.8rem;
    font-weight: 900;
    font-size: .9rem;
    border: 1px solid var(--border);
    background: #fff;
    text-decoration:none;
    transition: .15s ease;
    white-space: nowrap;
    cursor: pointer;
    text-align:center;
  }
  .action-pill:hover{ background:#F1F5F9; }

  .action-pill.edit{
    border-color: rgba(37,99,235,.25);
    background: rgba(37,99,235,.06);
    color:#1D4ED8;
  }
  .action-pill.edit:hover{ background: rgba(37,99,235,.10); }

  .action-pill.del{
    border-color: rgba(220,38,38,.25);
    background: rgba(239,68,68,.07);
    color:#DC2626;
  }
  .action-pill.del:hover{ background: rgba(239,68,68,.12); }

  .empty{
    padding: 3.5rem 1rem;
    text-align:center;
    color: var(--muted);
    font-weight: 800;
  }

  @media (max-width: 768px){
    .acc-page{ padding: 1.1rem 0; }
    .acc-title{ font-size: 1.25rem; }

    .top-row{
      align-items: stretch;
    }

    .acc-actions{
      justify-content: stretch;
      gap: .6rem;
      width: 100%;
    }
    .btn-action{ flex: 1 1 auto; }

    .sum-grid{
      grid-template-columns: 1fr;
      gap: .75rem;
    }

    .acc-table thead{ display:none; }
    .acc-table, .acc-table tbody, .acc-table tr{ display:block; width:100%; }
    .acc-table tr{
      padding: .95rem .95rem;
      border-bottom: 1px solid var(--border);
    }
    .acc-table td{
      display:grid;
      grid-template-columns: 92px 1fr;
      gap: .5rem;
      padding: .35rem 0;
      border: 0;
      text-align: left;
    }
    .acc-table td::before{
      content: attr(data-label);
      color: var(--muted);
      font-weight: 1000;
      font-size: .9rem;
    }
    .acc-table td[data-label="금액"]{ text-align: left; }

    .manage-wrap{
      justify-content:flex-start;
      flex-wrap: wrap;
      gap: .55rem;
    }
    .action-pill{
      padding: .55rem .9rem;
      font-size: .92rem;
    }
  }
</style>
</head>

<body>
<div class="acc-page">
  <div class="acc-wrap">

    <div class="acc-header">
      <div>
        <h2 class="acc-title">S-ANGEL 회계 장부</h2>
        <div class="acc-subtitle">
          {{ budget_year.year }}년도 S-ANGEL 회계 장부
        </div>
      </div>

      <a href="{% url 'applications:dashboard' %}" class="btn-ghost">
        <i class="fas fa-arrow-left"></i>대시보드
      </a>
    </div>

    <!-- 기수 이동 + 액션 -->
    <div class="top-row">
      <div class="year-select">
        <span class="badge-cat badge-event">
          <i class="fas fa-layer-group"></i>&nbsp;기수 선택
        </span>

        <!-- 드롭다운(가장 깔끔) -->
        <select class="select" onchange="if(this.value) location.href=this.value;">
          {% for y in all_years %}
            <option value="{% url 'applications:accounting_year_list' year=y.year %}"
                    {% if y.year == budget_year.year %}selected{% endif %}>
              {{ y.year }}년도{% if y.is_active %} (활성){% endif %}
            </option>
          {% endfor %}
        </select>

        <!-- ✅ 칩: 이전 / 현재 / 다음 (최대 3개) -->
        {% for y in year_buttons %}
        <a class="year-chip {% if y.year == budget_year.year %}active{% endif %}"
            href="{% url 'applications:accounting_year_list' year=y.year %}">
            {{ y.year }}{% if y.is_active %} · 활성{% endif %}
        </a>
        {% endfor %}

      </div>

      <div class="acc-actions">
        <a href="{% url 'applications:export_accounting_excel' year=budget_year.year %}" class="btn-action btn-excel">
          <i class="fas fa-file-excel"></i>엑셀 다운로드
        </a>

        {% if is_admin %}
          <a href="{% url 'applications:event_create' %}" class="btn-action btn-event">
            <i class="fas fa-calendar-plus"></i>행사 생성
          </a>
          <a href="{% url 'applications:accounting_create' %}" class="btn-action btn-add">
            <i class="fas fa-plus"></i>내역 추가
          </a>
        {% endif %}
      </div>
    </div>

    <!-- 총합 -->
    <div class="sum-grid">
      <div class="sum-card">
        <div class="sum-label">현재 잔액</div>
        <div class="sum-value sum-balance">{{ balance|intcomma }}원</div>
      </div>
      <div class="sum-card">
        <div class="sum-label">총 수입</div>
        <div class="sum-value sum-income">+ {{ total_income|intcomma }}원</div>
      </div>
      <div class="sum-card">
        <div class="sum-label">총 지출</div>
        <div class="sum-value sum-expense">- {{ total_expense|intcomma }}원</div>
      </div>
    </div>

    <!-- 타임라인 -->
    <div class="table-card">
  <table class="acc-table">
    <thead>
      <tr>
        <th style="width: 120px;">날짜</th>
        <th>항목</th>
        <th style="width: 140px;">구분</th>
        <th style="width: 150px;">금액</th>
        <th style="width: 180px;">관리/이동</th>
      </tr>
    </thead>

    <tbody>
      {% for item in timeline %}
        {% if item.transaction_type %}
          <tr>
            <td data-label="날짜">{{ item.date|date:"Y-m-d" }}</td>
            <td data-label="항목">
              <strong>{{ item.item_name }}</strong>
              {% if item.description %}
                <div style="margin-top:.25rem; font-size:.86rem; color:var(--muted); font-weight:800;">
                  {{ item.description|truncatechars:60 }}
                </div>
              {% endif %}
            </td>
            <td data-label="구분">
              <span class="badge-cat">
                {% if item.transaction_type == 'INCOME' %}수입{% else %}지출{% endif %}
              </span>
            </td>
            <td data-label="금액">
              {% if item.transaction_type == 'INCOME' %}
                <span class="money income">+ {{ item.amount|intcomma }}원</span>
              {% else %}
                <span class="money expense">- {{ item.amount|intcomma }}원</span>
              {% endif %}
            </td>
            <td data-label="관리/이동">
              <div class="manage-wrap">
                {% if is_admin %}
                  <a href="{% url 'applications:accounting_update' item.id %}" class="action-pill edit">
                    <i class="fas fa-pen"></i>수정
                  </a>
                  <form action="{% url 'applications:accounting_delete' item.id %}" method="post"
                        onsubmit="return confirm('정말 삭제하시겠습니까?');" style="margin:0;">
                    {% csrf_token %}
                    <button type="submit" class="action-pill del">
                      <i class="fas fa-trash"></i>삭제
                    </button>
                  </form>
                {% else %}-{% endif %}
              </div>
            </td>
          </tr>

        {% else %}
          {% with s=item.get_summary %}
          <tr class="event-row" style="background-color: #f0f4ff;">
            <td data-label="날짜">{{ item.date|date:"Y-m-d" }}</td>
            <td data-label="항목">
              <a href="{% url 'applications:accounting_event_detail' item.id %}" style="text-decoration:none; color:inherit;">
                <strong style="color: var(--navy);">
                  <i class="fas fa-folder-open"></i> {{ item.name }}
                </strong>
              </a>
              {% if item.description %}
                <div style="margin-top:.25rem; font-size:.86rem; color:var(--muted); font-weight:800;">
                  {{ item.description|truncatechars:60 }}
                </div>
              {% endif %}
            </td>
            <td data-label="구분">
              <span class="badge-cat badge-event">행사 요약</span>
            </td>
            <td data-label="금액">
              <div class="money income" style="font-size: 0.85rem;">+ {{ s.income|intcomma }}</div>
              <div class="money expense" style="font-size: 0.85rem;">- {{ s.expense|intcomma }}</div>
              <div class="money total" style="border-top: 1px solid var(--border);">{{ s.total|intcomma }}원</div>
            </td>
            <td data-label="관리/이동">
                <div class="manage-wrap">
                    {% if is_admin %}
                    <a href="{% url 'applications:accounting_event_update' item.id %}" class="action-pill edit">
                        <i class="fas fa-edit"></i> 수정
                    </a>
                    
                    <form action="{% url 'applications:accounting_event_delete' item.id %}" method="post" 
                            onsubmit="return confirm('행사를 삭제하면 그 안의 모든 내역도 함께 삭제됩니다. 정말 삭제할까요?');" style="margin:0;">
                        {% csrf_token %}
                        <button type="submit" class="action-pill del">
                        <i class="fas fa-trash"></i> 삭제
                        </button>
                    </form>
                    {% else %}<a href="{% url 'applications:accounting_event_detail' item.id %}" class="action-pill" style="background: var(--navy); color:white; border:none;">
                        상세보기
                        </a>
                    {% endif %}
                </div>
                </td>
          </tr>
          {% endwith %}
        {% endif %}

      {% empty %}
        <tr><td colspan="5" class="empty">기록된 회계 내역/행사가 없습니다.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

  </div>
</div>
</body>
</html>
