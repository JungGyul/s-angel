<!DOCTYPE html> 
<html lang="ko">
 <head>
 <meta charset="UTF-8"> 
<meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>관리자 페이지</title> 
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% load static %}

<style>
  :root{
    --navy:#1E3A8A;
    --navy2:#312E81;
    --bg:#F9FAFB;
    --card:#FFFFFF;
    --border:#E5E7EB;
    --text:#0F172A;
    --muted:#64748B;
    --danger:#EF4444;
    --dangerBg:#FEF2F2;
    --shadow: 0 10px 18px rgba(15, 23, 42, 0.06);
    --ring: 0 0 0 3px rgba(30,58,138,.18);
    --radius: 16px;
  }

  /* ✅ iOS Safari에서 가로 튐/줌/레이아웃 깨짐 방지 핵심 */
  html, body { max-width: 100%; overflow-x: hidden; }
  *{ box-sizing:border-box; }
  img, svg{ max-width:100%; height:auto; }
  input, select, textarea, button { font: inherit; }
  input, select, textarea { min-width:0; }
  /* iOS zoom 방지(폼 포커스 시 확대) - 필요하면 16px 이상 */
  .search-input, .gen-select, .form-control, .form-select{ font-size:16px; }

  .admin-page{
    background: radial-gradient(1200px 500px at 25% -10%, rgba(30,58,138,.08), transparent 60%),
                radial-gradient(900px 400px at 90% 0%, rgba(49,46,129,.06), transparent 55%),
                var(--bg);
    color: var(--text);
    min-height: 100vh;
    padding: 1.8rem 0;
  }

  .admin-wrap{
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
  }

  .page-header{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap: 1rem;
    padding-bottom: 1.25rem;
    border-bottom: 1px solid var(--border);
    margin-bottom: 1.5rem;
  }

  .page-title{
    margin:0;
    font-weight: 1000;
    font-size: 1.9rem;
    letter-spacing: -0.02em;
    border-left: 5px solid var(--navy);
    padding-left: .9rem;
    line-height: 1.15;
  }

  .header-actions{
    display:flex;
    gap: .65rem;
    flex-wrap: wrap;
    align-items:center;
  }

  /* ✅ 버튼(부트스트랩 없어도 보기 유지) */
  .btn-pill{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:.45rem;
    padding: .7rem 1rem;
    border-radius: 14px;
    font-weight: 600;
    text-decoration:none;
    border: 1px solid var(--border);
    background: #fff;
    color: var(--text);
    cursor: pointer;
    transition: .15s ease;
    white-space: nowrap;
    user-select:none;
    line-height: 1;
  }
  .btn-pill:hover{ background:#F1F5F9; }

  /* ✅ (수정본) 회계 장부 버튼 hover 깜빡임 완화 */
  .btn-primary{
    background: linear-gradient(135deg, var(--navy) 0%, var(--navy2) 100%);
    color:#fff;
    border: none;
    box-shadow: 0 12px 20px rgba(30,58,138,.22);
    transition: filter .15s ease, transform .15s ease, box-shadow .15s ease; /* ✅ 명시 */
    will-change: filter, transform; /* ✅ 사파리에서 깜빡임 완화 */
  }
  .btn-primary:hover{
    background: linear-gradient(135deg, var(--navy) 0%, var(--navy2) 100%); /* ✅ 유지 */
    filter: brightness(.97);
    transform: translateY(-1px);
    box-shadow: 0 14px 24px rgba(30,58,138,.26);
  }

  /* ✅ 알림(기존 누락된 custom-alert 복구) */
  .custom-alert{
    display:flex;
    align-items:center;
    gap:.75rem;
    padding: .95rem 1rem;
    border: 1px solid var(--border);
    border-left: 5px solid var(--navy);
    background: #fff;
    border-radius: 12px;
    box-shadow: var(--shadow);
    margin-bottom: 1rem;
    color: #334155;
    font-weight: 600;
  }
  .custom-alert i{
    color: var(--navy);
    font-size: 1.15rem;
  }

  .grid{
    display:grid;
    grid-template-columns: 5fr 7fr;
    gap: 1rem;
  }

  .card{
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow:hidden;
  }

  .card-head{
    padding: 1rem 1.25rem;
    background: #F8FAFC;
    border-bottom: 1px solid var(--border);
    font-weight: 600;
    color: #334155;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:.75rem;
  }

  .card-body{
    padding: 1rem 1.25rem;
  }

  .badge{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding: .25rem .6rem;
    border-radius: 999px;
    font-weight: 600;
    font-size: .82rem;
    border: 1px solid var(--border);
    background: #fff;
    color: #334155;
    white-space: nowrap;
  }
  .badge-danger{
    border-color: rgba(239,68,68,.25);
    background: rgba(239,68,68,.08);
    color: #B91C1C;
  }
  .badge-gray{
    background: #fff;
    color: #334155;
  }

  .user-item{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap: 1rem;
    padding: 1rem 0;
    border-bottom: 1px solid var(--border);
  }
  .user-item:last-child{ border-bottom: none; }

  .user-details strong{
    font-size: 1.02rem;
    font-weight: 700;
    color: #0F172A;
  }
  .user-details small{
    color: var(--muted);
    font-weight: 600;
    display:block;
    margin-top: .25rem;
  }

  .user-details-link{
    text-decoration:none;
    color: inherit;
  }
  .user-details-link:hover strong{
    color: var(--navy);
    text-decoration: underline;
  }

  .btn-mini{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:.4rem;
    padding: .45rem .75rem;
    border-radius: 10px;
    font-weight: 600;
    border: 1px solid var(--border);
    background: #fff;
    cursor:pointer;
    transition:.15s ease;
    white-space: nowrap;
    line-height: 1;
  }
  .btn-mini:hover{ background:#F1F5F9; }

  .btn-danger{
    background: var(--dangerBg);
    border: 1px solid rgba(239,68,68,.25);
    color: #B91C1C;
  }
  .btn-danger:hover{
    background: rgba(239,68,68,.12);
  }

  /* ✅ 검색/필터 */
  .filter-bar{
    display:flex;
    gap: .75rem;
    margin-bottom: 1rem;
    align-items: stretch;
  }

  .search-form{ position:relative; flex: 1 1 auto; }
  .search-icon{
    position:absolute;
    left: .9rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--muted);
    pointer-events:none;
  }
  .search-input{
    width:100%;
    padding: .75rem 1rem .75rem 2.5rem;
    border: 1px solid var(--border);
    border-radius: 12px;
    background:#fff;
    font-weight: 500;
    color:#0F172A;
  }
  .search-input:focus{
    outline:none;
    box-shadow: var(--ring);
    border-color: rgba(30,58,138,.5);
  }

  .gen-select{
    width: 160px;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 0 .9rem;
    background:#fff;
    font-weight: 500;
    color:#0F172A;
    /* iOS select 튐 방지 */
    max-width: 100%;
  }
  .gen-select:focus{
    outline:none;
    box-shadow: var(--ring);
    border-color: rgba(30,58,138,.5);
  }

  /* ✅ 가중치 폼 */
  .weight-form{
    display:flex;
    align-items:center;
    gap: .6rem;
    flex-wrap: wrap;
    margin-top: .6rem;
  }
  .weight-form label{
    color: var(--muted);
    font-weight: 600;
    font-size: .85rem;
  }
  .weight-input{
    width: 82px;
    padding: .5rem .6rem;
    border: 1px solid var(--border);
    border-radius: 10px;
    font-weight: 600;
  }
  .weight-input:focus{
    outline:none;
    box-shadow: var(--ring);
    border-color: rgba(30,58,138,.5);
  }

  /* ✅ 모바일 */
  @media (max-width: 992px){
    .grid{ grid-template-columns: 1fr; }
  }

  @media (max-width: 768px){
    .admin-page{ padding: 1.1rem 0; }
    .page-title{ font-size: 1.35rem; }

    .page-header{
      flex-direction: column;
      align-items: flex-start;
      gap: .85rem;
    }

    .header-actions{
      width: 100%;
      flex-direction: column;
      align-items: stretch;
    }
    .btn-pill{ width: 100%; }

    .filter-bar{
      flex-direction: column;
      gap: .6rem;
    }
    .gen-select{
      width: 100%;
      height: 46px;
    }

    .user-item{
      flex-direction: column;
      align-items: stretch;
      gap: .75rem;
    }
    .weight-form{
    width: 100%;
    flex-wrap: wrap;
    align-items: stretch;
  }

  /* 입력칸은 고정 폭(또는 원하는 폭) 유지 */
  .weight-input{
    width: 90px;
    flex: 0 0 90px;
  }

  /* ✅ 수정 버튼은 다음 줄로 내려서 100% 폭으로 */
  .weight-form .btn-mini{
    width: 100%;
    justify-content: center;
    flex: 0 0 100%;
    min-height: 44px;          /* iOS 터치 영역 */
    flex-shrink: 0;            /* 혹시 모를 축소 방지 */
  }
  }

  /* ✅ 아이콘 margin 클래스(me-2 등) 없이도 정렬 깨지지 않게 */
  .btn-pill i, .btn-mini i{ margin: 0 !important; }
</style>
 </head>
 <body>
<div class="admin-page">
  <div class="admin-wrap">

    <header class="page-header">
      <h1 class="page-title"><i class="fas fa-user-cog"></i> 관리자 페이지</h1>

      <div class="header-actions">
        <a href="{% url 'applications:accounting_list' %}" class="btn-pill btn-primary">
          <i class="fas fa-calculator"></i>회계 장부 관리
        </a>
        <a href="{% url 'applications:dashboard' %}" class="btn-pill">
          <i class="fas fa-arrow-left"></i>대시보드
        </a>
      </div>
    </header>

    {% if messages %}
      {% for message in messages %}
        <div class="custom-alert" role="alert">
          <i class="fas fa-check-circle"></i>
          <span>{{ message }}</span>
        </div>
      {% endfor %}
    {% endif %}

    <div class="grid">

      <!-- 가입 승인 대기 -->
      <section class="card">
        <div class="card-head">
          <div>
            <i class="fas fa-user-clock"></i>
            가입 승인 대기
          </div>
          <span class="badge badge-danger">{{ pending_users.count }} 명</span>
        </div>

        <div class="card-body">
          {% for p_user in pending_users %}
            <div class="user-item">
              <div class="user-details">
                <strong>{{ p_user.name }}</strong> ({{ p_user.username }})
                <small>신청: {{ p_user.date_joined|date:"Y.m.d" }}</small>
              </div>

              <div style="display:flex; gap:.5rem; flex-wrap:wrap;">
                <form action="{% url 'applications:approve_user' p_user.id %}" method="post" style="margin:0;">
                  {% csrf_token %}
                  <button type="submit" class="btn-mini">
                    <i class="fas fa-check"></i>승인
                  </button>
                </form>

                <form action="{% url 'applications:reject_user' p_user.id %}" method="post"
                      onsubmit="return confirm('정말로 {{ p_user.username }} 님의 가입을 거절하시겠습니까?');"
                      style="margin:0;">
                  {% csrf_token %}
                  <button type="submit" class="btn-mini btn-danger">
                    <i class="fas fa-times"></i>거절
                  </button>
                </form>
              </div>
            </div>
          {% empty %}
            <div style="padding:1.25rem 0; color:var(--muted); font-weight:600; text-align:center;">
              승인 대기중인 사용자가 없습니다.
            </div>
          {% endfor %}
        </div>
      </section>

      <!-- 사용자 관리 -->
      <section class="card">
        <div class="card-head">
          <div>
            <i class="fas fa-users"></i>
            사용자 관리
          </div>
          <span class="badge badge-gray">{{ active_users.count }} 명</span>
        </div>

        <div class="card-body">

          <div class="filter-bar">
            <form method="get" action="{% url 'applications:admin_page' %}" class="search-form" id="searchForm">
              <i class="fas fa-search search-icon"></i>
              <input type="text" name="q" class="search-input" placeholder="사용자 아이디 또는 이름으로 검색"
                     value="{{ search_query|default_if_none:'' }}">
              <input type="hidden" name="gen" value="{{ gen_filter|default_if_none:'' }}">
            </form>

            <select class="gen-select" id="genSelect">
              <option value="">전체 기수</option>
              {% for g in generations %}
                <option value="{{ g }}" {% if gen_filter == g|stringformat:"i" %}selected{% endif %}>{{ g }}기</option>
              {% endfor %}
            </select>
          </div>

          {% for a_user in active_users %}
            <div class="user-item">
              <div style="flex:1 1 auto;">
                <div class="user-details">
                  <a href="{% url 'applications:update_user_info' a_user.id %}" class="user-details-link">
                    <strong>{{ a_user.name }}</strong>
                  </a>
                  <span style="color:var(--muted); font-weight:450; margin-left:.35rem;">({{ a_user.username }}, {{ a_user.generation }}기)</span>
                  {% if a_user.is_staff %}
                    <span class="badge" style="margin-left:.5rem; border-color: rgba(59,130,246,.25); background: rgba(59,130,246,.08); color:#1D4ED8;">Admin</span>
                  {% endif %}

                  <!-- ✅ (수정본) 회계열람 토글 시 확인 메시지 -->
                  <form action="{% url 'applications:toggle_accounting_permission' a_user.id %}"
                        method="post"
                        onsubmit="return confirm('{% if a_user.can_view_accounting %}회계 열람을 차단할까요?{% else %}회계 열람을 허용할까요?{% endif %}');"
                        style="display:inline-block; margin-left:.5rem;">
                    {% csrf_token %}
                    <button type="submit" class="btn-mini"
                            style="
                              border-radius:999px;
                              padding:.38rem .65rem;
                              font-size:.85rem;
                              border: 1px solid var(--border);
                              background: {% if a_user.can_view_accounting %}rgba(16,185,129,.10){% else %}#fff{% endif %};
                              color: {% if a_user.can_view_accounting %}#047857{% else %}#475569{% endif %};
                            ">
                      <i class="fas {% if a_user.can_view_accounting %}fa-eye{% else %}fa-eye-slash{% endif %}"></i>
                      회계열람 {% if a_user.can_view_accounting %}허용{% else %}차단{% endif %}
                    </button>
                  </form>
                </div>

                <form action="{% url 'applications:update_user_weight' a_user.id %}" method="post" class="weight-form">
                  {% csrf_token %}
                  <label for="weight-{{ a_user.id }}">가중치</label>
                  <input id="weight-{{ a_user.id }}" type="number" name="weight" value="{{ a_user.weight }}"
                         class="weight-input" min="1" inputmode="numeric">
                  <button type="submit" class="btn-mini">
                    <i class="fas fa-pencil-alt"></i>수정
                  </button>
                </form>
              </div>

              <div>
                {% if not a_user.is_staff %}
                  <form action="{% url 'applications:delete_user' a_user.id %}" method="post"
                        onsubmit="return confirm('정말로 {{ a_user.username }} 사용자를 삭제하시겠습니까?');"
                        style="margin:0;">
                    {% csrf_token %}
                    <button type="submit" class="btn-mini btn-danger" title="삭제">
                      <i class="fas fa-trash-alt"></i>삭제
                    </button>
                  </form>
                {% endif %}
              </div>
            </div>
          {% empty %}
            <div style="padding:1.25rem 0; color:var(--muted); font-weight:600; text-align:center;">
              {% if search_query %}
                '{{ search_query }}'에 대한 검색 결과가 없습니다.
              {% else %}
                활성 사용자가 없습니다.
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </section>

    </div>
  </div>
</div>

<script>
  // ✅ 기수 필터 변경 시 URL 안전하게 구성(특수문자/공백 방지)
  (function () {
    const genSelect = document.getElementById('genSelect');
    const searchForm = document.getElementById('searchForm');
    if (!genSelect || !searchForm) return;

    genSelect.addEventListener('change', function () {
      const params = new URLSearchParams(new FormData(searchForm));
      params.set('gen', this.value || '');
      const url = window.location.pathname + '?' + params.toString();
      window.location.href = url;
    });
  })();
</script>
</body> 
</html>
