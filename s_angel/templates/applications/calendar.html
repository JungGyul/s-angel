<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ìº˜ë¦°ë” í˜ì´ì§€</title>

  <!-- Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://npmcdn.com/flatpickr/dist/themes/material_blue.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/ko.js"></script>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>

  <!-- Pretendard -->
  <link rel="stylesheet" as="style" crossorigin
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@1.3.9/dist/web/static/pretendard.css" />

  <style>
    :root{
      --navy:#1E3A8A; --navy2:#312E81; --bg:#F8FAFC; --card:#FFFFFF; --border:#E5E7EB;
      --text:#0F172A; --muted:#64748B; --shadow:0 14px 28px rgba(15,23,42,.08);
      --shadow-sm:0 8px 18px rgba(15,23,42,.06); --ring:0 0 0 3px rgba(30,58,138,.16);
      --radius:16px;
    }
    html,body{max-width:100%;overflow-x:hidden;}
    body{
      font-family:Pretendard,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",Arial,sans-serif;
      background:
        radial-gradient(1200px 500px at 20% -10%, rgba(30,58,138,.10), transparent 60%),
        radial-gradient(900px 400px at 95% 0%, rgba(49,46,129,.08), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    .page-wrap{max-width:1050px;margin:0 auto;padding:2.2rem 1rem 3rem;}
    .topbar{display:flex;justify-content:space-between;align-items:flex-start;gap:1rem;margin-bottom:1rem;}
    .title-block h2{margin:0;font-weight:900;font-size:1.65rem;letter-spacing:-.02em;line-height:1.2;}
    .title-block p{margin:.35rem 0 0;color:var(--muted);font-weight:500;font-size:.95rem;}
    .btn-back{
      display:inline-flex;align-items:center;gap:.5rem;padding:.7rem 1rem;border-radius:14px;
      background:rgba(255,255,255,.85);border:1px solid var(--border);color:var(--text);
      text-decoration:none;font-weight:700;transition:transform .15s ease, box-shadow .15s ease, background .15s ease;
      box-shadow:var(--shadow-sm);white-space:nowrap;user-select:none;
    }
    .btn-back:hover{transform:translateY(-1px);background:#fff;box-shadow:var(--shadow);}

    .calendar-card{
      background:rgba(255,255,255,.88);backdrop-filter:blur(10px);
      border:1px solid rgba(229,231,235,.92);border-radius:var(--radius);
      box-shadow:var(--shadow);overflow:hidden;
    }
    .calendar-head{
      padding:1rem 1.25rem;border-bottom:1px solid var(--border);
      background:linear-gradient(135deg, rgba(30,58,138,.06), rgba(49,46,129,.04));
      display:flex;align-items:center;justify-content:space-between;gap:.75rem;flex-wrap:wrap;
    }
    .calendar-head .tag{
      display:inline-flex;align-items:center;gap:.5rem;padding:.45rem .75rem;border-radius:999px;
      font-weight:800;font-size:.9rem;border:1px solid rgba(30,58,138,.20);
      background:rgba(30,58,138,.06);color:var(--navy);
    }
    .calendar-body{padding:1rem 1.25rem 1.25rem;}

    /* FullCalendar */
    .fc{--fc-border-color:rgba(226,232,240,.95);--fc-today-bg-color:rgba(30,58,138,.06);--fc-page-bg-color:transparent;font-weight:500;}
    .fc .fc-toolbar-title{font-weight:900;letter-spacing:-.02em;color:var(--text);}
    .fc .fc-button{
      border:1px solid var(--border)!important;background:#fff!important;color:var(--text)!important;
      border-radius:12px!important;padding:.55rem .8rem!important;font-weight:800!important;box-shadow:none!important;
      transition:transform .12s ease, background .12s ease;
    }
    .fc .fc-button:hover{background:#F1F5F9!important;transform:translateY(-1px);}
    .fc .fc-button-primary:not(:disabled).fc-button-active{
      background:linear-gradient(135deg,var(--navy),var(--navy2))!important;border-color:transparent!important;color:#fff!important;
    }
    .fc .fc-button:focus{box-shadow:var(--ring)!important;outline:none!important;}
    .fc .fc-col-header-cell-cushion{padding:.6rem 0;color:#334155;font-weight:800;text-decoration:none;}
    .fc .fc-daygrid-day-number{color:#334155;font-weight:700;text-decoration:none;padding:.35rem .45rem;border-radius:10px;margin:.25rem;}
    .fc .fc-daygrid-day.fc-day-today .fc-daygrid-day-number{background:rgba(30,58,138,.10);color:var(--navy);}
    .fc .fc-daygrid-day-frame{padding:.15rem;border-radius:14px;transition:background .12s ease;}
    .fc .fc-daygrid-day:hover .fc-daygrid-day-frame{background:rgba(2,6,23,.02);}
    .fc .fc-daygrid-event{
      border:none!important;border-radius:10px!important;padding:2px 6px!important;margin:2px 4px!important;
      cursor:pointer;box-shadow:0 6px 14px rgba(15,23,42,.10);
    }
    .fc .fc-event-title{font-weight:800;letter-spacing:-.01em;font-size:.86rem;}
    .fc .fc-daygrid-more-link{font-weight:800;color:var(--navy);text-decoration:none;}

    /* Modal */
    .modal-content{border-radius:18px;border:1px solid rgba(226,232,240,.9);box-shadow:0 22px 50px rgba(0,0,0,.18);overflow:hidden;}
    .modal-header{background:linear-gradient(135deg, rgba(30,58,138,.08), rgba(49,46,129,.05));border-bottom:1px solid rgba(226,232,240,.9);padding:1rem 1.25rem;}
    .modal-title{font-weight:900;letter-spacing:-.02em;}
    .modal-body{padding:1rem 1.25rem;}
    .modal-body label{font-weight:800;color:#475569;}
    .form-control,.form-control-color{border-radius:12px;border:1px solid rgba(203,213,225,.9);font-weight:600;}
    .form-control:focus,.form-control-color:focus{border-color:rgba(30,58,138,.5);box-shadow:var(--ring);outline:none;}
    .btn-primary-custom{
      background:linear-gradient(135deg,var(--navy),var(--navy2));border:none;font-weight:900;border-radius:14px;padding:.7rem 1rem;
      transition:transform .12s ease, filter .12s ease;
    }
    .btn-primary-custom:hover{transform:translateY(-1px);filter:brightness(.98);}
    .btn-danger-soft{
      background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.20);color:#B91C1C;font-weight:900;border-radius:14px;padding:.7rem 1rem;
      transition:transform .12s ease, background .12s ease;
    }
    .btn-danger-soft:hover{transform:translateY(-1px);background:rgba(239,68,68,.12);}

    /* flatpickr highlight */
    .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange {
      background: var(--navy) !important;
      border-color: var(--navy) !important;
    }

    @media (max-width: 768px) {
      .topbar{flex-direction:column;align-items:stretch;}
      .btn-back{width:100%;justify-content:center;}
      .calendar-body{padding:1rem;}
      .calendar-head{padding:0.75rem 1rem!important;justify-content:space-between!important;}
      .calendar-head .tag{font-size:0.75rem!important;padding:0.3rem 0.6rem!important;}
      .title-block h2{font-size:1.35rem;}

      .fc .fc-toolbar-title{font-size:1.1rem!important;}
      .fc .fc-col-header-cell-cushion{font-size:0.7rem!important;padding:2px 0!important;}
      .fc .fc-daygrid-day-number{font-size:0.65rem!important;padding:2px!important;font-weight:600;}
      .fc-daygrid-event{margin:0.5px 0!important;padding:0 2px!important;border-radius:2px!important;min-height:12px!important;line-height:12px!important;}
      .fc-event-title{font-size:0.55rem!important;font-weight:700!important;letter-spacing:-0.02em!important;line-height:12px!important;}
      .fc-daygrid-more-link{font-size:0.5rem!important;margin-top:0!important;line-height:1!important;}
      .fc .fc-button{font-size:0.7rem!important;padding:0.35rem 0.5rem!important;border-radius:8px!important;}

      .btn-primary-custom{padding:0.4rem 0.7rem!important;font-size:0.75rem!important;border-radius:10px!important;height:auto!important;}
      .btn-primary-custom i{font-size:0.75rem!important;margin-right:0.3rem!important;}
    }
  </style>
</head>

<body>
  <div class="page-wrap">
    <div class="topbar">
      <div class="title-block">
        <h2>ğŸ“… S-ANGEL ì¼ì • ìº˜ë¦°ë”</h2>
        <p>S-ANGEL ì „ì²´ ì¼ì •ì„ í™•ì¸ í•  ìˆ˜ ìˆì–´ìš”.</p>
      </div>
      <a href="{% url 'applications:dashboard' %}" class="btn-back">
        <i class="fas fa-arrow-left"></i> ëŒ€ì‹œë³´ë“œ
      </a>
    </div>

    <div class="calendar-card">
      <div class="calendar-head">
        <span class="tag"><i class="fas fa-calendar-check"></i> S-ANGEL SCHEDULE</span>
        <div style="display:flex; gap:.5rem; align-items:center;">
          {% if is_admin %}
            <button type="button" class="btn btn-primary-custom text-white" onclick="openCreateModal()">
              <i class="fas fa-plus"></i> ì¼ì • ì¶”ê°€
            </button>
          {% endif %}
        </div>
      </div>

      <div class="calendar-body">
        <div id="calendar"></div>
      </div>
    </div>
  </div>

  <!-- CSRF í† í° (DOMì—ì„œ ì½ì–´ì˜¤ê¸°ìš©) -->
  <form style="display:none">{% csrf_token %}</form>

  <!-- Modal -->
  <div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">ì¼ì • ìƒì„¸</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <form id="eventForm">
            <input type="hidden" id="eventId">

            <div class="mb-3">
              <label class="small text-muted">ì¼ì • ì œëª©</label>
              <input type="text" id="editTitle" class="form-control" {% if not is_admin %}readonly{% endif %}>
            </div>

            <div class="mb-3">
              <label class="small text-muted">ì¼ì‹œ</label>
              <div class="d-flex flex-column gap-2">
                <div class="d-flex align-items-center gap-2">
                  <span class="badge bg-light text-dark">ì‹œì‘</span>
                  <input type="text" id="editStart" class="form-control bg-white"
                         placeholder="ë‚ ì§œì™€ ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”" {% if not is_admin %}readonly{% endif %}>
                </div>
                <div class="d-flex align-items-center gap-2">
                  <span class="badge bg-light text-dark">ì¢…ë£Œ</span>
                  <input type="text" id="editEnd" class="form-control bg-white"
                         placeholder="ë‚ ì§œì™€ ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”" {% if not is_admin %}readonly{% endif %}>
                </div>
              </div>
            </div>

            <div class="mb-3">
              <label class="small text-muted">ìƒì„¸ ë‚´ìš©</label>
              <textarea id="editContent" class="form-control" rows="3" {% if not is_admin %}readonly{% endif %}></textarea>
            </div>

            {% if is_admin %}
            <div class="mb-1">
              <label class="small text-muted">ê°•ì¡° ìƒ‰ìƒ</label>
              <input type="color" id="editColor" class="form-control form-control-color w-100" value="#1E3A8A">
            </div>
            {% endif %}
          </form>
        </div>

        <div class="modal-footer border-0 justify-content-between px-4 pb-4">
          {% if is_admin %}
            <button type="button" class="btn-danger-soft" onclick="deleteEvent()">
              <i class="fas fa-trash-alt"></i> ì‚­ì œ
            </button>
            <button type="button" class="btn btn-primary-custom text-white" onclick="saveEvent()">
              ì €ì¥
            </button>
          {% else %}
            <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">ë‹«ê¸°</button>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== ì„œë²„ í…œí”Œë¦¿ ê°’ =====
    const IS_ADMIN = {{ is_admin|yesno:"true,false" }};

    // ===== Utilities =====
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    function getCsrfToken() {
      const el = document.querySelector('[name=csrfmiddlewaretoken]');
      if (el && el.value) return el.value;
      return getCookie('csrftoken');
    }

    async function safeJson(res) {
      const text = await res.text();
      try { return JSON.parse(text); }
      catch { return { _raw: text }; }
    }

    // âœ… í•µì‹¬: ë¬¸ìì—´ì„ new Date()ë¡œ íŒŒì‹±í•˜ì§€ ë§ê³ ,
    // flatpickrê°€ ê°€ì§„ Date ê°ì²´(selectedDates[0])ë¥¼ ê·¸ëŒ€ë¡œ ISO(Z)ë¡œ ë³´ë‚¸ë‹¤.
    function pickerToIsoZ(picker) {
      const d = picker?.selectedDates?.[0];
      return d ? d.toISOString() : null;
    }

    let calendar;
    let eventModal;
    let startPicker;
    let endPicker;

    document.addEventListener('DOMContentLoaded', function () {
      eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
      const calendarEl = document.getElementById('calendar');

      // ===== Flatpickr =====
      const fpBase = {
        enableTime: true,
        dateFormat: "Y-m-d H:i",
        time_24hr: true,
        locale: "ko",
        disableMobile: true,   // âœ… boolean
        allowInput: IS_ADMIN,  // ê´€ë¦¬ìë§Œ ì…ë ¥/ìˆ˜ì •
        clickOpens: IS_ADMIN,  // ê´€ë¦¬ìë§Œ picker ì—´ê¸°
        minuteIncrement: 5,
        monthSelectorType: 'static'
      };

      startPicker = flatpickr("#editStart", {
        ...fpBase,
        onChange: function(selectedDates) {
          if (!selectedDates?.[0]) return;
          const s = selectedDates[0];
          // ì¢…ë£Œ ìµœì†Œê°’ ì œí•œ
          endPicker.set('minDate', s);

          // endê°€ startë³´ë‹¤ ë¹ ë¥´ë©´ endë¥¼ startë¡œ ìë™ ë³´ì • (ì„œë²„ì—ì„œ end ì‚­ì œë˜ëŠ” ê²ƒ ë°©ì§€)
          const e = endPicker.selectedDates?.[0];
          if (e && e < s) endPicker.setDate(s, true);
        }
      });

      endPicker = flatpickr("#editEnd", {
        ...fpBase,
        onChange: function(selectedDates) {
          // ì¢…ë£Œ ì„ íƒí•˜ë©´ start max ì œí•œ (ì›í•˜ë©´ ìœ ì§€)
          const e = selectedDates?.[0];
          if (e) startPicker.set('maxDate', e);
          else startPicker.set('maxDate', null);
        }
      });

      // ===== FullCalendar =====
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ko',
        timeZone: 'Asia/Seoul',   // âœ… ëª…ì‹œ (ì•ˆì •)
        fixedWeekCount: false,
        dayMaxEvents: 5,
        eventDisplay: 'block',
        events: {{ schedules_json|safe }},
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth' },

        eventClick: function (info) {
          fillModalFromEvent(info.event);
          eventModal.show();
        }
      });

      calendar.render();
    });

    function fillModalFromEvent(event) {
      document.getElementById('modalTitle').textContent = 'ì¼ì • ìƒì„¸';
      document.getElementById('eventId').value = event.id || '';
      document.getElementById('editTitle').value = event.title || '';
      document.getElementById('editContent').value =
        (event.extendedProps && event.extendedProps.content) ? event.extendedProps.content : '';

      const start = event.start;             // Date (local)
      const end = event.end || null;         // Date or null

      startPicker.setDate(start, true);
      endPicker.setDate(end, true);

      // ì œì•½ ì¡°ê±´ë„ ë™ê¸°í™”
      endPicker.set('minDate', start);
      if (end) startPicker.set('maxDate', end);
      else startPicker.set('maxDate', null);

      const colorEl = document.getElementById('editColor');
      if (colorEl) colorEl.value = event.backgroundColor || event.color || '#1E3A8A';
    }

    function openCreateModal() {
  document.getElementById('modalTitle').textContent = 'ìƒˆ ì¼ì • ì¶”ê°€';
  document.getElementById('eventId').value = '';
  document.getElementById('editTitle').value = '';
  document.getElementById('editContent').value = '';

  // âœ… ì§€ê¸ˆì´ 16:47ì´ë©´ 16:00ìœ¼ë¡œ ë§ì¶”ê¸°
  const now = new Date();
  now.setMinutes(0);
  now.setSeconds(0);
  now.setMilliseconds(0);

  // (ì„ íƒ) ê¸°ë³¸ ì¢…ë£Œì‹œê°„: 1ì‹œê°„ ë’¤
  const end = new Date(now.getTime() + 60 * 60 * 1000);

  startPicker.set('maxDate', null);
  endPicker.set('minDate', now);

  startPicker.setDate(now, true);
  endPicker.setDate(end, true);

  const colorEl = document.getElementById('editColor');
  if (colorEl) colorEl.value = '#1E3A8A';

  eventModal.show();
}

    // ===== CRUD =====
    async function saveEvent() {
      if (!IS_ADMIN) return;

      const id = document.getElementById('eventId').value;
      const colorEl = document.getElementById('editColor');

      const title = (document.getElementById('editTitle').value || '').trim();
      if (!title) {
        alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      const startISO = pickerToIsoZ(startPicker);
      const endISO = pickerToIsoZ(endPicker);

      if (!startISO) {
        alert('ì‹œì‘ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      // endê°€ startë³´ë‹¤ ë¹ ë¥´ë©´ endë¥¼ nullë¡œ (ì„œë²„ë„ ê°™ì€ ì²˜ë¦¬)
      let finalEndISO = endISO;
      if (startPicker.selectedDates?.[0] && endPicker.selectedDates?.[0]) {
        if (endPicker.selectedDates[0] <= startPicker.selectedDates[0]) {
          finalEndISO = null;
        }
      }

      const payload = {
        title,
        start: startISO,
        end: finalEndISO,
        content: document.getElementById('editContent').value || '',
        color: colorEl ? colorEl.value : '#1E3A8A'
      };

      const url = id ? `/applications/calendar/update/${id}/`
                     : `/applications/calendar/add/`;

      try {
        const res = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
          },
          body: JSON.stringify(payload)
        });

        const data = await safeJson(res);

        if (!res.ok) {
          const rawHint = data && data._raw ? `\n\n(ì„œë²„ ì‘ë‹µ ì¼ë¶€)\n${String(data._raw).slice(0, 300)}` : '';
          alert(`ì €ì¥ ì‹¤íŒ¨ (HTTP ${res.status})\nê´€ë¦¬ì ê¶Œí•œ/CSRF/URLì„ í™•ì¸í•˜ì„¸ìš”.${rawHint}`);
          return;
        }

        if (data.status === 'success') location.reload();
        else alert(data.message || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      } catch (e) {
        alert('ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    async function deleteEvent() {
      if (!IS_ADMIN) return;

      const id = document.getElementById('eventId').value;
      if (!id) {
        alert('ì•„ì§ ì €ì¥ë˜ì§€ ì•Šì€ ì¼ì •ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      if (!confirm('ì •ë§ë¡œ ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        const res = await fetch(`/applications/calendar/delete/${id}/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
          }
        });

        const data = await safeJson(res);

        if (!res.ok) {
          const rawHint = data && data._raw ? `\n\n(ì„œë²„ ì‘ë‹µ ì¼ë¶€)\n${String(data._raw).slice(0, 300)}` : '';
          alert(`ì‚­ì œ ì‹¤íŒ¨ (HTTP ${res.status})\nê´€ë¦¬ì ê¶Œí•œ/CSRF/URLì„ í™•ì¸í•˜ì„¸ìš”.${rawHint}`);
          return;
        }

        if (data.status === 'success') location.reload();
        else alert(data.message || 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      } catch (e) {
        alert('ë„¤íŠ¸ì›Œí¬ ì—°ê²° ë¬¸ì œë¡œ ì‚­ì œ ìš”ì²­ì„ ë³´ë‚´ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
      }
    }
  </script>
</body>
</html>
