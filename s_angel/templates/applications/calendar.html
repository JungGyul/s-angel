<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ìº˜ë¦°ë” í˜ì´ì§€</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>

  <!-- Pretendard -->
  <link rel="stylesheet" as="style" crossorigin
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@1.3.9/dist/web/static/pretendard.css" />

  <style>
    :root{
      --navy:#1E3A8A; --navy2:#312E81; --bg:#F8FAFC; --card:#FFFFFF; --border:#E5E7EB;
      --text:#0F172A; --muted:#64748B; --shadow:0 14px 28px rgba(15,23,42,.08);
      --shadow-sm:0 8px 18px rgba(15,23,42,.06); --ring:0 0 0 3px rgba(30,58,138,.16);
      --radius:16px;
    }
    html,body{max-width:100%;overflow-x:hidden;}
    body{
      font-family:Pretendard,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",Arial,sans-serif;
      background:
        radial-gradient(1200px 500px at 20% -10%, rgba(30,58,138,.10), transparent 60%),
        radial-gradient(900px 400px at 95% 0%, rgba(49,46,129,.08), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    .page-wrap{max-width:1050px;margin:0 auto;padding:2.2rem 1rem 3rem;}
    .topbar{display:flex;justify-content:space-between;align-items:flex-start;gap:1rem;margin-bottom:1rem;}
    .title-block h2{margin:0;font-weight:900;font-size:1.65rem;letter-spacing:-.02em;line-height:1.2;}
    .title-block p{margin:.35rem 0 0;color:var(--muted);font-weight:500;font-size:.95rem;}
    .btn-back{
      display:inline-flex;align-items:center;gap:.5rem;padding:.7rem 1rem;border-radius:14px;
      background:rgba(255,255,255,.85);border:1px solid var(--border);color:var(--text);
      text-decoration:none;font-weight:700;transition:transform .15s ease, box-shadow .15s ease, background .15s ease;
      box-shadow:var(--shadow-sm);white-space:nowrap;user-select:none;
    }
    .btn-back:hover{transform:translateY(-1px);background:#fff;box-shadow:var(--shadow);}

    .calendar-card{
      background:rgba(255,255,255,.88);backdrop-filter:blur(10px);
      border:1px solid rgba(229,231,235,.92);border-radius:var(--radius);
      box-shadow:var(--shadow);overflow:hidden;
    }
    .calendar-head{
      padding:1rem 1.25rem;border-bottom:1px solid var(--border);
      background:linear-gradient(135deg, rgba(30,58,138,.06), rgba(49,46,129,.04));
      display:flex;align-items:center;justify-content:space-between;gap:.75rem;flex-wrap:wrap;
    }
    .calendar-head .tag{
      display:inline-flex;align-items:center;gap:.5rem;padding:.45rem .75rem;border-radius:999px;
      font-weight:800;font-size:.9rem;border:1px solid rgba(30,58,138,.20);
      background:rgba(30,58,138,.06);color:var(--navy);
    }
    .calendar-body{padding:1rem 1.25rem 1.25rem;}

    /* FullCalendar */
    .fc{--fc-border-color:rgba(226,232,240,.95);--fc-today-bg-color:rgba(30,58,138,.06);--fc-page-bg-color:transparent;font-weight:500;}
    .fc .fc-toolbar-title{font-weight:900;letter-spacing:-.02em;color:var(--text);}
    .fc .fc-button{
      border:1px solid var(--border)!important;background:#fff!important;color:var(--text)!important;
      border-radius:12px!important;padding:.55rem .8rem!important;font-weight:800!important;box-shadow:none!important;
      transition:transform .12s ease, background .12s ease;
    }
    .fc .fc-button:hover{background:#F1F5F9!important;transform:translateY(-1px);}
    .fc .fc-button-primary:not(:disabled).fc-button-active{
      background:linear-gradient(135deg,var(--navy),var(--navy2))!important;border-color:transparent!important;color:#fff!important;
    }
    .fc .fc-button:focus{box-shadow:var(--ring)!important;outline:none!important;}
    .fc .fc-col-header-cell-cushion{padding:.6rem 0;color:#334155;font-weight:800;text-decoration:none;}
    .fc .fc-daygrid-day-number{color:#334155;font-weight:700;text-decoration:none;padding:.35rem .45rem;border-radius:10px;margin:.25rem;}
    .fc .fc-daygrid-day.fc-day-today .fc-daygrid-day-number{background:rgba(30,58,138,.10);color:var(--navy);}
    .fc .fc-daygrid-day-frame{padding:.15rem;border-radius:14px;transition:background .12s ease;}
    .fc .fc-daygrid-day:hover .fc-daygrid-day-frame{background:rgba(2,6,23,.02);}
    .fc .fc-daygrid-event{
      border:none!important;border-radius:10px!important;padding:2px 6px!important;margin:2px 4px!important;
      cursor:pointer;box-shadow:0 6px 14px rgba(15,23,42,.10);
    }
    .fc .fc-event-title{font-weight:800;letter-spacing:-.01em;font-size:.86rem;}
    .fc .fc-daygrid-more-link{font-weight:800;color:var(--navy);text-decoration:none;}

    /* Modal */
    .modal-content{border-radius:18px;border:1px solid rgba(226,232,240,.9);box-shadow:0 22px 50px rgba(0,0,0,.18);overflow:hidden;}
    .modal-header{background:linear-gradient(135deg, rgba(30,58,138,.08), rgba(49,46,129,.05));border-bottom:1px solid rgba(226,232,240,.9);padding:1rem 1.25rem;}
    .modal-title{font-weight:900;letter-spacing:-.02em;}
    .modal-body{padding:1rem 1.25rem;}
    .modal-body label{font-weight:800;color:#475569;}
    .form-control,.form-control-color{border-radius:12px;border:1px solid rgba(203,213,225,.9);font-weight:600;}
    .form-control:focus,.form-control-color:focus{border-color:rgba(30,58,138,.5);box-shadow:var(--ring);outline:none;}
    .btn-primary-custom{
      background:linear-gradient(135deg,var(--navy),var(--navy2));border:none;font-weight:900;border-radius:14px;padding:.7rem 1rem;
      transition:transform .12s ease, filter .12s ease;
    }
    .btn-primary-custom:hover{transform:translateY(-1px);filter:brightness(.98);}
    .btn-danger-soft{
      background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.20);color:#B91C1C;font-weight:900;border-radius:14px;padding:.7rem 1rem;
      transition:transform .12s ease, background .12s ease;
    }
    .btn-danger-soft:hover{transform:translateY(-1px);background:rgba(239,68,68,.12);}

    @media(max-width:768px){
      .topbar{flex-direction:column;align-items:stretch;}
      .btn-back{width:100%;justify-content:center;}
      .calendar-body{padding:1rem;}
      .calendar-head{padding:1rem;}
      .title-block h2{font-size:1.35rem;}
      .fc .fc-toolbar-title {
        font-size: 1.1rem !important;
    }

    /* 2. ìš”ì¼ í—¤ë” í¬ê¸° (ì¼, ì›”, í™”...) */
    .fc .fc-col-header-cell-cushion {
        font-size: 0.75rem !important;
        padding: 4px 0 !important;
    }

    /* 3. ë‚ ì§œ ìˆ«ì í¬ê¸° */
    .fc .fc-daygrid-day-number {
        font-size: 0.7rem !important;
        padding: 2px 4px !important;
        margin: 1px !important;
    }

    /* 4. ë“±ë¡ëœ ì¼ì •(ì´ë²¤íŠ¸) ê¸€ì í¬ê¸° */
    .fc .fc-event-title {
        font-size: 0.65rem !important;
        font-weight: 700 !important;
        letter-spacing: -0.03em !important;
    }

    /* 5. ë²„íŠ¼(ì˜¤ëŠ˜, <, >, month) í¬ê¸° */
    .fc .fc-button {
        font-size: 0.7rem !important;
        padding: 0.35rem 0.5rem !important;
        border-radius: 8px !important;
    }

    /* 6. 'ë”ë³´ê¸°' ë§í¬ í¬ê¸° (+2ê°œ ë” ë³´ê¸° ë“±) */
    .fc .fc-daygrid-more-link {
        font-size: 0.65rem !important;
    }

    /* 7. ìƒë‹¨ íƒœê·¸ ë° ë²„íŠ¼ ë°” ê°„ê²© ì¡°ì ˆ */
    .calendar-head {
        padding: 0.75rem !important;
    }
    .calendar-head .tag {
        font-size: 0.75rem !important;
        padding: 0.3rem 0.6rem !important;
    }
    .btn-primary-custom {
        padding: 0.4rem 0.8rem !important; /* ìƒí•˜ì¢Œìš° ì—¬ë°± ì¶•ì†Œ */
        font-size: 0.8rem !important;      /* ê¸€ì í¬ê¸° ì¶•ì†Œ */
        border-radius: 10px !important;    /* ë‘¥ê·¼ ì •ë„ë¥¼ ëª¨ë°”ì¼ì— ë§ê²Œ ì¡°ì ˆ */
        height: auto !important;           /* ë†’ì´ ìë™ ì¡°ì ˆ */
    }

    /* 2. ë²„íŠ¼ ë‚´ í”ŒëŸ¬ìŠ¤(+) ì•„ì´ì½˜ í¬ê¸° ì¡°ì ˆ */
    .btn-primary-custom i {
        font-size: 0.75rem !important;     /* ì•„ì´ì½˜ í¬ê¸° ì‚´ì§ ì¶•ì†Œ */
        margin-right: 0.3rem !important;   /* ì•„ì´ì½˜ê³¼ í…ìŠ¤íŠ¸ ì‚¬ì´ ê°„ê²© ì¶•ì†Œ */
    }

    /* 3. ë²„íŠ¼ì´ í¬í•¨ëœ ìƒë‹¨ ì˜ì—­(calendar-head) ì •ë ¬ ë³´ì • */
    .calendar-head {
        padding: 0.75rem 1rem !important;
        justify-content: space-between !important; /* ì–‘ ë ì •ë ¬ ìœ ì§€ */
    }
    }
  </style>
</head>

<body>
  <div class="page-wrap">
    <div class="topbar">
      <div class="title-block">
        <h2>ğŸ“… S-ANGEL ì¼ì • ìº˜ë¦°ë”</h2>
        <p>S-ANGEL ì „ì²´ ì¼ì •ì„ í™•ì¸ í•  ìˆ˜ ìˆì–´ìš”.</p>
      </div>
      <a href="{% url 'applications:dashboard' %}" class="btn-back">
        <i class="fas fa-arrow-left"></i> ëŒ€ì‹œë³´ë“œ
      </a>
    </div>

    <!-- âœ… calendar-card ë˜í¼ (ë„¤ ì½”ë“œì—ì„œ ë¹ ì ¸ ìˆì—ˆìŒ) -->
    <div class="calendar-card">
      <div class="calendar-head">
        <span class="tag"><i class="fas fa-calendar-check"></i> S-ANGEL SCHEDULE</span>

        <div style="display:flex; gap:.5rem; align-items:center;">
          {% if is_admin %}
            <button type="button" class="btn btn-primary-custom text-white" onclick="openCreateModal()">
              <i class="fas fa-plus"></i> ì¼ì • ì¶”ê°€
            </button>
          {% endif %}
        </div>
      </div>

      <div class="calendar-body">
        <div id="calendar"></div>
      </div>
    </div>
  </div>

  <!-- âœ… CSRF í† í°ì„ í™•ì‹¤íˆ ìƒì„±/ì„¸íŒ…(ì¿ í‚¤ ë°œê¸‰ ë³´ì¡°) -->
  <form style="display:none">{% csrf_token %}</form>

  <!-- Modal -->
  <div class="modal fade" id="eventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">ì¼ì • ìƒì„¸</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <form id="eventForm">
            <input type="hidden" id="eventId">

            <div class="mb-3">
              <label class="small text-muted">ì¼ì • ì œëª©</label>
              <input type="text" id="editTitle" class="form-control" {% if not is_admin %}readonly{% endif %}>
            </div>

            <div class="mb-3">
              <label class="small text-muted">ë‚ ì§œ</label>
              <div class="d-flex gap-2">
                <input type="date" id="editStart" class="form-control" {% if not is_admin %}readonly{% endif %}>
                <input type="date" id="editEnd" class="form-control" {% if not is_admin %}readonly{% endif %}>
              </div>
            </div>

            <div class="mb-3">
              <label class="small text-muted">ìƒì„¸ ë‚´ìš©</label>
              <textarea id="editContent" class="form-control" rows="3" {% if not is_admin %}readonly{% endif %}></textarea>
            </div>

            {% if is_admin %}
            <div class="mb-1">
              <label class="small text-muted">ê°•ì¡° ìƒ‰ìƒ</label>
              <input type="color" id="editColor" class="form-control form-control-color w-100" value="#1E3A8A">
            </div>
            {% endif %}
          </form>
        </div>

        <div class="modal-footer border-0 justify-content-between px-4 pb-4">
          {% if is_admin %}
            <button type="button" class="btn-danger-soft" onclick="deleteEvent()">
              <i class="fas fa-trash-alt"></i> ì‚­ì œ
            </button>
            <button type="button" class="btn btn-primary-custom text-white" onclick="saveEvent()">
              ì €ì¥
            </button>
          {% else %}
            <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">ë‹«ê¸°</button>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <script>
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
    const csrftoken = getCookie('csrftoken');

    let calendar;
    let eventModal;

    document.addEventListener('DOMContentLoaded', function () {
      eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
      const calendarEl = document.getElementById('calendar');

      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ko',
        fixedWeekCount: false,
        dayMaxEvents: true,
        events: {{ schedules_json|safe }},
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth' },

        eventClick: function (info) {
          fillModalFromEvent(info.event);
          eventModal.show();
        }
      });

      calendar.render();
    });

    function fillModalFromEvent(event) {
      document.getElementById('modalTitle').textContent = 'ì¼ì • ìƒì„¸';
      document.getElementById('eventId').value = event.id || '';
      document.getElementById('editTitle').value = event.title || '';

      const startStr = event.startStr;
      const endStr = event.endStr || startStr;

      document.getElementById('editStart').value = startStr;
      document.getElementById('editEnd').value = endStr;

      document.getElementById('editContent').value =
        (event.extendedProps && event.extendedProps.content) ? event.extendedProps.content : '';

      const colorEl = document.getElementById('editColor');
      if (colorEl) colorEl.value = event.backgroundColor || event.color || '#1E3A8A';
    }

    function openCreateModal() {
        document.getElementById('modalTitle').textContent = 'ìƒˆ ì¼ì • ì¶”ê°€';
        document.getElementById('eventId').value = '';
        document.getElementById('editTitle').value = '';
        document.getElementById('editContent').value = '';

        // âœ… ì˜¤ëŠ˜ ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ê°€ì ¸ì˜¤ê¸°
        const now = new Date();
        const offset = now.getTimezoneOffset() * 60000; // ì‹œì°¨ ê³„ì‚°
        const today = new Date(now - offset).toISOString().slice(0, 10);

        // âœ… ì…ë ¥ì°½ì— ì˜¤ëŠ˜ ë‚ ì§œ ì„¸íŒ…
        document.getElementById('editStart').value = today;
        document.getElementById('editEnd').value = today;

        const colorEl = document.getElementById('editColor');
        if (colorEl) colorEl.value = '#1E3A8A';

        eventModal.show();
    }

    // âœ… JSONì´ ì•„ë‹ ë•Œë„(403/302/500 HTML) ì›ì¸ì„ ë³´ì—¬ì£¼ë„ë¡ ê°œì„ 
    async function safeJson(res) {
      const text = await res.text();
      try { return JSON.parse(text); }
      catch { return { _raw: text }; }
    }

    // calendar.html ë‚´ë¶€ ìŠ¤í¬ë¦½íŠ¸ ìˆ˜ì •

// âœ… ë³€ê²½: ì¿ í‚¤ ëŒ€ì‹  DOMì—ì„œ ì§ì ‘ í† í°ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ (ë” í™•ì‹¤í•¨)
function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

async function saveEvent() {
    const id = document.getElementById('eventId').value;
    const colorEl = document.getElementById('editColor');

    const payload = {
        title: document.getElementById('editTitle').value,
        start: document.getElementById('editStart').value,
        end: document.getElementById('editEnd').value,
        content: document.getElementById('editContent').value,
        color: colorEl ? colorEl.value : '#1E3A8A'
    };

    // idê°€ ì—†ìœ¼ë©´ 'add', ìˆìœ¼ë©´ 'update' ê²½ë¡œë¡œ ì „ì†¡
    const url = id ? `/applications/calendar/update/${id}/`
                   : `/applications/calendar/add/`;

    try {
        const res = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken() // âœ… í˜¸ì¶œ ì‹œì ì— ì‹ ì„ í•œ í† í°ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
            },
            body: JSON.stringify(payload)
        });

        const data = await safeJson(res);

        if (!res.ok) {
            // 403 ì—ëŸ¬ ë°œìƒ ì‹œ ìƒì„¸ ì›ì¸ ì¶œë ¥
            alert(`ì €ì¥ ì‹¤íŒ¨ (HTTP ${res.status})\n\nê´€ë¦¬ì ê¶Œí•œì´ ì—†ê±°ë‚˜ ë³´ì•ˆ í† í°(CSRF)ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
            return;
        }

        if (data.status === 'success') {
            location.reload();
        } else {
            alert(data.message || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (e) {
        alert('ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

    async function deleteEvent() {
    const id = document.getElementById('eventId').value;
    
    // 1. ì €ì¥ë˜ì§€ ì•Šì€(IDê°€ ì—†ëŠ”) ì¼ì •ì¸ì§€ í™•ì¸
    if (!id) {
        alert('ì•„ì§ ì €ì¥ë˜ì§€ ì•Šì€ ì¼ì •ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    if (!confirm('ì •ë§ë¡œ ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    // 2. ìµœì‹  CSRF í† í° ê°€ì ¸ì˜¤ê¸° (ì´ì „ì— ë§Œë“  í•¨ìˆ˜ í™œìš©)
    const token = document.querySelector('[name=csrfmiddlewaretoken]').value;

    try {
        // 3. URL ëì— ìŠ¬ë˜ì‹œ(/)ê°€ ë¹ ì§€ì§€ ì•Šì•˜ëŠ”ì§€ ê¼­ í™•ì¸í•˜ì„¸ìš”!
        const res = await fetch(`/applications/calendar/delete/${id}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': token,  // ë³´ì•ˆ ì—´ì‡  ì „ë‹¬
                'Content-Type': 'application/json'
            }
        });

        // ì—ëŸ¬ ìƒì„¸ ë‚´ìš©ì„ íŒŒì•…í•˜ê¸° ìœ„í•´ safeJson í™œìš©
        const data = await safeJson(res);

        if (!res.ok) {
            alert(`ì‚­ì œ ì‹¤íŒ¨ (HTTP ${res.status})\n\në³´ì•ˆ í† í°ì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.`);
            return;
        }

        if (data.status === 'success') {
            location.reload(); // ì„±ê³µ ì‹œ ìƒˆë¡œê³ ì¹¨
        } else {
            alert(data.message || 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch (e) {
        alert('ë„¤íŠ¸ì›Œí¬ ì—°ê²° ë¬¸ì œë¡œ ì‚­ì œ ìš”ì²­ì„ ë³´ë‚´ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
    }
}
  </script>
</body>
</html>
